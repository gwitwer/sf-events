<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Events - TBA Venue Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        
        #map { height: 100vh; width: 100%; }
        
        .tba-marker {
            background: #ff9800;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .confirmed-marker {
            background: #4CAF50;
        }
        
        .tba-popup {
            max-width: 350px;
        }
        
        .tba-popup h3 {
            margin-bottom: 10px;
            color: #ff9800;
        }
        
        .resolution-suggestions {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .resolution-item {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .resolution-item:last-child {
            border-bottom: none;
        }
        
        .confidence-high { color: #4CAF50; font-weight: bold; }
        .confidence-medium { color: #FF9800; }
        .confidence-low { color: #9E9E9E; }
        
        .tba-panel {
            position: fixed;
            right: 10px;
            top: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .tba-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .tba-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tba-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .tba-item:hover {
            background: #f9f9f9;
        }
        
        .tba-item-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .tba-item-info {
            font-size: 12px;
            color: #666;
        }
        
        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="tba-panel">
        <h2>üéØ TBA Venue Tracker</h2>
        
        <div class="tba-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTBA">0</div>
                <div class="stat-label">TBA Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolved">0</div>
                <div class="stat-label">Potential Resolutions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="neighborhoods">0</div>
                <div class="stat-label">Likely Areas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="promoters">0</div>
                <div class="stat-label">Known Promoters</div>
            </div>
        </div>
        
        <h3>TBA Events This Week</h3>
        <div class="tba-list" id="tbaList"></div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-marker" style="background: #4CAF50;"></div>
            <span>Confirmed Venue</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #ff9800;"></div>
            <span>TBA - City Center</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #2196F3;"></div>
            <span>Potential Venue</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let tbaEvents = [];
        let resolutions = {};
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([37.7749, -122.4194], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        // Load TBA events and resolutions
        async function loadData() {
            try {
                // Load geocoded events
                const eventsResponse = await fetch('events_all_geocoded.json');
                const allEvents = await eventsResponse.json();
                
                // Filter TBA events
                tbaEvents = allEvents.filter(e => 
                    e.venue && /TBA|TBD/i.test(e.venue)
                );
                
                // Try to load resolutions
                try {
                    const resFiles = await fetch('/api/events');  // This would need an endpoint
                    // For now, we'll just use the TBA events as-is
                } catch (e) {
                    console.log('No resolutions file found');
                }
                
                displayTBAEvents();
                updateStats();
                
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }
        
        // Display TBA events on map
        function displayTBAEvents() {
            tbaEvents.forEach(event => {
                if (event.coordinates) {
                    // Create custom icon for TBA events
                    const icon = L.divIcon({
                        className: 'tba-marker',
                        html: '?',
                        iconSize: [30, 30]
                    });
                    
                    const marker = L.marker(
                        [event.coordinates.lat, event.coordinates.lon],
                        { icon }
                    );
                    
                    // Create popup with resolution info
                    const popupContent = createTBAPopup(event);
                    marker.bindPopup(popupContent);
                    
                    marker.addTo(map);
                }
            });
        }
        
        // Create popup content for TBA events
        function createTBAPopup(event) {
            let html = `
                <div class="tba-popup">
                    <h3>üìç TBA Venue</h3>
                    <div><strong>${event.title}</strong></div>
                    <div>üìÖ ${event.dayLabel} ${event.timeRange || ''}</div>
                    <div>üéµ ${event.genres ? event.genres.join(', ') : 'Unknown'}</div>
                    ${event.promoters && event.promoters.length > 0 ? 
                        `<div>üë• ${event.promoters.join(', ')}</div>` : ''}
                    
                    <div class="resolution-suggestions">
                        <strong>üîç Venue Suggestions:</strong>
                        <div class="resolution-item">
                            <span class="confidence-low">‚Ä¢ Likely in SOMA/Mission area</span>
                        </div>
                        ${event.promoters && event.promoters.length > 0 ?
                            `<div class="resolution-item">
                                <span class="confidence-medium">‚Ä¢ Check promoter's usual venues</span>
                            </div>` : ''}
                    </div>
                    
                    ${event.url ? 
                        `<a href="${event.url}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 6px 12px; background: #ff9800; color: white; text-decoration: none; border-radius: 4px;">Check Event Page</a>` 
                        : ''}
                </div>
            `;
            return html;
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalTBA').textContent = tbaEvents.length;
            
            // Count events with potential resolutions
            const withResolutions = tbaEvents.filter(e => 
                e.promoters && e.promoters.length > 0
            ).length;
            document.getElementById('resolved').textContent = withResolutions;
            
            // Count unique neighborhoods mentioned
            const neighborhoods = new Set();
            tbaEvents.forEach(e => {
                if (e.genres) {
                    // Infer neighborhoods from genres
                    if (e.genres.some(g => /techno|house|warehouse/.test(g.toLowerCase()))) {
                        neighborhoods.add('SOMA');
                    }
                    if (e.genres.some(g => /latin|reggaeton/.test(g.toLowerCase()))) {
                        neighborhoods.add('Mission');
                    }
                }
            });
            document.getElementById('neighborhoods').textContent = neighborhoods.size;
            
            // Count unique promoters
            const promoters = new Set();
            tbaEvents.forEach(e => {
                if (e.promoters) {
                    e.promoters.forEach(p => promoters.add(p));
                }
            });
            document.getElementById('promoters').textContent = promoters.size;
            
            // Populate TBA list
            populateTBAList();
        }
        
        // Populate TBA events list
        function populateTBAList() {
            const list = document.getElementById('tbaList');
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const weekEvents = tbaEvents
                .filter(e => {
                    if (!e.dateISO) return false;
                    const eventDate = new Date(e.dateISO);
                    return eventDate >= today && eventDate <= nextWeek;
                })
                .sort((a, b) => a.dateISO.localeCompare(b.dateISO));
            
            list.innerHTML = weekEvents.map(event => `
                <div class="tba-item" onclick="focusEvent(${event.coordinates?.lat}, ${event.coordinates?.lon})">
                    <div class="tba-item-title">${event.title}</div>
                    <div class="tba-item-info">
                        üìÖ ${event.dayLabel} ${event.timeRange || ''}<br>
                        üéµ ${event.genres ? event.genres.slice(0, 2).join(', ') : 'Unknown'}
                        ${event.promoters && event.promoters.length > 0 ? 
                            `<br>üë• ${event.promoters[0]}` : ''}
                    </div>
                </div>
            `).join('');
            
            if (weekEvents.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No TBA events this week</div>';
            }
        }
        
        // Focus on specific event
        function focusEvent(lat, lon) {
            if (lat && lon) {
                map.setView([lat, lon], 15);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            initMap();
            loadData();
        });
    </script>
</body>
</html>